<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Merrow Postmortem: Patches - Hangedman Design</title><meta name="description" content="Merrow (randomizer) postmortem: patches"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://www.hangedmandesign.com/merrow-postmortem-patches/"><meta property="og:title" content="Merrow Postmortem: Patches"><meta property="og:image" content="https://www.hangedmandesign.com/media/posts/30/merrow_frenchvanilla_s3.png"><meta property="og:image:width" content="320"><meta property="og:image:height" content="240"><meta property="og:site_name" content="Hangedman Design"><meta property="og:description" content="Merrow (randomizer) postmortem: patches"><meta property="og:url" content="https://www.hangedmandesign.com/merrow-postmortem-patches/"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://www.hangedmandesign.com/media/website/favicon.png" type="image/png"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Aleo:400,700&amp;display=swap" rel="stylesheet"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:'Aleo',serif;--logo-font:var(--heading-font);--menu-font:var(--body-font)}</style><link rel="stylesheet" href="https://www.hangedmandesign.com/assets/css/style.css?v=8e47a1318adae9db3bd09ff28e130b65"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.hangedmandesign.com/merrow-postmortem-patches/"},"headline":"Merrow Postmortem: Patches","datePublished":"2023-12-08T23:36","dateModified":"2023-12-11T11:45","image":{"@type":"ImageObject","url":"https://www.hangedmandesign.com/media/posts/30/merrow_frenchvanilla_s3.png","height":240,"width":320},"description":"Merrow (randomizer) postmortem: patches","author":{"@type":"Person","name":"Hangedman","url":"https://www.hangedmandesign.com/authors/hangedman/"},"publisher":{"@type":"Organization","name":"Hangedman","logo":{"@type":"ImageObject","url":"https://www.hangedmandesign.com/media/website/hangedlogovec-2.svg","height":58,"width":38}}}</script></head><body><div class="container js-container"><nav class="menu"><ul class="navbar__menu"><li><a href="https://www.hangedmandesign.com/" target="_self">Home</a></li><li class="has-submenu"><span>QA</span><ul class="navbar__submenu"><li><a href="https://www.hangedmandesign.com/chicory-a-colorful-tale/" target="_self">Chicory: A Colorful Tale</a></li><li><a href="https://www.hangedmandesign.com/i-was-a-teenage-exocolonist/" target="_self">I Was A Teenage Exocolonist</a></li><li><a href="https://www.hangedmandesign.com/tunic/" target="_self">TUNIC</a></li></ul></li><li class="has-submenu"><span>GAME DESIGN</span><ul class="navbar__submenu"><li><a href="https://www.hangedmandesign.com/gemeton-and-gemeton-arcade/" target="_self">Gemeton (and Gemeton Arcade)</a></li><li><a href="https://www.hangedmandesign.com/merrow/" target="_self">Merrow</a></li><li class="has-submenu"><a href="https://www.hangedmandesign.com/miscellaneous-games/" target="_self">Miscellaneous: Games</a><ul class="navbar__submenu"><li><a href="https://www.hangedmandesign.com/the-dead-prince-and-the-pacifican-express/" target="_self">Dead Prince &amp; The Pacifican Express</a></li></ul></li></ul></li><li class="has-submenu"><span>WRITING</span><ul class="navbar__submenu"><li><a href="https://www.hangedmandesign.com/neotokyo-manual/" target="_self">NEOTOKYO° Manual</a></li><li><a href="https://www.hangedmandesign.com/technical-writing/" target="_self">Technical Writing</a></li></ul></li><li class="has-submenu"><span>VISUAL DESIGN</span><ul class="navbar__submenu"><li><a href="https://www.hangedmandesign.com/famicase/" target="_self">Famicase</a></li><li><a href="https://www.hangedmandesign.com/mute/" target="_self">Mute City</a></li></ul></li><li class="has-submenu"><span>COMMUNITY</span><ul class="navbar__submenu"><li><a href="https://www.hangedmandesign.com/dirty-rectangles/" target="_self">Dirty Rectangles</a></li><li><a href="https://www.hangedmandesign.com/sustainable-game-dev-communities/" target="_self">Sustainable Game Dev Communities</a></li></ul></li><li class="has-submenu"><span>CONTACT/LINKS</span><ul class="navbar__submenu"><li><a href="https://www.hangedmandesign.com/contact/" target="_self">Contact</a></li><li><a href="https://dirty-rectangles.com" target="_self">Dirty Rectangles (website)</a></li><li><a href="https://hangedman.itch.io" target="_blank">Itch.io (Game projects)</a></li><li><a href="https://twitch.tv/hangedman" target="_blank">Twitch</a></li><li><a href="https://twitter.com/JonahD" target="_blank">Twitter</a></li><li><a href="https://bsky.app/profile/hangedman.bsky.social" target="_blank">Bluesky</a></li></ul></li></ul></nav><div class="content"><header class="top"><div class="top__item"><a class="logo" href="https://www.hangedmandesign.com/"><img src="https://www.hangedmandesign.com/media/website/hangedlogovec-2.svg" alt="Hangedman Design"></a></div><div class="top__item top__item--right"><button class="menu-toggle js-menu-toggle" aria-label="Menu" aria-expanded="false"><span class="menu-toggle-box"><span class="menu-toggle-inner">Menu</span></span></button></div></header><main class="main"><article class="post"><div class="main__left"><figure class="hero"><img src="https://www.hangedmandesign.com/media/posts/30/merrow_frenchvanilla_s3.png" srcset="https://www.hangedmandesign.com/media/posts/30/responsive/merrow_frenchvanilla_s3-xs.png 300w, https://www.hangedmandesign.com/media/posts/30/responsive/merrow_frenchvanilla_s3-sm.png 480w, https://www.hangedmandesign.com/media/posts/30/responsive/merrow_frenchvanilla_s3-md.png 768w, https://www.hangedmandesign.com/media/posts/30/responsive/merrow_frenchvanilla_s3-lg.png 1024w, https://www.hangedmandesign.com/media/posts/30/responsive/merrow_frenchvanilla_s3-xl.png 1280w, https://www.hangedmandesign.com/media/posts/30/responsive/merrow_frenchvanilla_s3-2xl.png 1600w" sizes="(min-width: 61.3125em) 50vw, 100vw" loading="eager" height="240" width="320" alt=""></figure><header><h1>Merrow Postmortem: Patches</h1></header></div><div class="main__right"><div class="post__entry"><p>This whole randomizer business all started because of IPS.</p><p>IPS is an old-school patching format, and the only one that I was aware of from old days of applying translation patches, etc. There have been lots of newer patching formats since then, of course, but I was only vaguely aware of them.</p><p>So when I was asked if I could make a patch that would make one specific change in Quest 64, I thought of IPS. Searching for info about IPS patches and how I could make them, I found the ZeroSoft spec page for IPS that broke down how a patch is structured: <a href="https://zerosoft.zophar.net/ips.php" target="_blank" rel="noopener noreferrer">https://zerosoft.zophar.net/ips.php</a>.</p><p>The important thing this showed me about IPS was that despite not having any fancy features or protections, IPS is extremely simple and (mostly) human-readable.</p><p>If you open an IPS patch in a hex editor, it consists of this:</p><ul><li>A 5-byte [header], which is just the word <em>"PATCH"</em> written out in ascii hex values: [<code>50 41 54 43 48</code>].</li><li>Some number of [records], which I'll detail below.</li><li>A 3-byte [footer], which is just the word <em>"EOF"</em> (End Of File) in ascii hex: [<code>45 4F 46</code>]. </li></ul><p>Records are little chunks of data of variable length, that are made up of 3 parts:</p><ul><li>A 3-byte [offset], which is a hex address from [<code>000000</code>]-[<code>FFFFFF</code>], where data will be written.</li><li>A 2-byte [size], which is the number of bytes of data to write to a patched file.</li><li>[Data], which is [size] bytes of data in a row that you want to write at the location specified in [offset].</li></ul><p>IPS can do a couple other things too, but reading that spec was enough for me to realize something a bit silly - <strong>this patching format is just a bunch of hexadecimal text</strong>. And while I didn't know then how to move data around, I definitely knew how to fiddle with text strings in C#.</p><p>Having clumsily learned a few different kinds of coding over the years, editing strings was easy. And it turned out that every patch (and every file, or game, or application) is actually just one giant wall of hexadecimal characters, which could be stored as a string.</p><p>[<code>50415443481A2A3A025B6B454F46</code>]: the content of an IPS patch that writes two [<code>02</code>] bytes of data [<code>5B 6B</code>] to the patched file starting at an address [<code>1A2A3A</code>]. <br>Might be easier to read if I write it like this:<br>[<code>[5041544348][1A2A3A][02][5B6B][454F46]</code>].<br>So this patch changes the byte at address [<code>1A2A3A</code>] to [<code>5B</code>], and [<code>1A2A3B</code>] to [<code>6B</code>].</p><p>There's more to it than that, to be fair - that patch data I just wrote up there is ascii text, and you can't just rename a text file containing that to .IPS and expect it to work.<br>But you can take a text string like that one, and code a little function in almost any language that makes a <strong>binary </strong>file that contains that patch data, stored in hex rather than text. And that's an IPS patch.</p><p>So my randomizer kicked off from there. Once I realized I could just write addresses and data as strings, bash them together with <em>"PATCH"</em> and <em>"EOF"</em>, and convert it to a binary file, I was set. Here's an example from the randomizer code to show what I mean:</p><pre>/* Fast Monastery: write 00090002 as new door target ID at 4361A0 */<br>if (rndFastMonasteryToggle.Checked) <br>{ <br>    patchstrings.Add("4361A0");<br>    patchstrings.Add("0004");<br>    patchstrings.Add("00090002"); <br>}</pre><p>The code says, if the option <em>"Fast Monastery"</em> is enabled, my big list of patch strings will get three things added that will edit one in-game door's data: the offset, the size, and that many bytes of data. And that patch will tell the patcher to write the [<code>04</code>] bytes [<code>00 09 00 02</code>] to the file, starting at [<code>4361A0</code>], which changes where the door goes.<br><br>Each option enabled in the randomizer like the one above, will add to that giant pile of patch strings. And then at the end, after all the options are processed:</p><pre>/* Patching mode: CREATE IPS PATCH */<br>if (expModePatchIPS.Checked) <br>{<br>    patchbuild += headerHex;<br>    /* mash all the patch strings together */<br>    for (int ps = 0; ps &lt; patchparts; ps++)  <br>    { <br>        patchbuild += patchstrings[ps]; <br>    }<br>    patchbuild += footerHex;<br>}<br>/* convert the string to a bytearray */<br>patcharray = StringToByteArray(patchbuild, true); <br>/* write the bytearray to an ips file */<br>File.WriteAllBytes(filePath + fileName + ".ips", patcharray); </pre><p>This function makes one big string, that contains the IPS header, all the offset/size/data triplets in order, and the IPS footer. Then it converts that string to a ByteArray, which turns it from hex <strong>text </strong>to hex <strong>binary</strong>, and then saves that to a new .ips file.</p><p>It's kind of a simple brute-force method with no error checking, but it works, which is the most important thing.<br>Here's the StringToByteArray function, just for reference:</p><pre>/* Convert hex string to byte array */<br>public static byte[] StringToByteArray(string hex, bool addZero) { <br>    int NumberChars = hex.Length;<br>    /* Add a leading zero to odd-length hex */<br>    if (NumberChars % 2 != 0) <br>    {<br>        hex = "0" + hex;<br>        NumberChars++;<br>    }<br>    byte[] bytes = new byte[NumberChars / 2];<br>    /* Fill the byte array, two hex characters at a time */<br>    for (int i = 0; i &lt; NumberChars; i += 2) <br>    { <br>      bytes[i / 2] = Convert.ToByte(hex.Substring(i, 2), 16); <br>    }<br>    return bytes;<br>}</pre><p>Not too long after writing this code, I realized I didn't even need to export IPS patches anymore. I could just tell the randomizer to edit files directly, using those same addresses and strings as instructions. But I'll get to that another time.</p><p>It's all just hex, if you dig deep enough. No matter how complex the game, or app, or file, it's eventually just hex. Once I realized that, the terrible enormity of the goofy stuff I could get away with started to hit me.</p><p>And no one stopped me, so a randomizer happened.</p></div></div></article></main><footer class="footer"><div class="footer__copyright">Content © Hangedman Design. Sine Mora.<br>Powered by <a href="https://getpublii.com" target="_blank" rel="nofollow noopener">Publii</a>. Non Possumus Non Non Esse.</div></footer></div></div><script defer="defer" src="https://www.hangedmandesign.com/assets/js/scripts.min.js?v=babd20e2a0a25821e63a0529c9feaae0"></script><script>var images = document.querySelectorAll('img[loading]');
   
           for (var i = 0; i < images.length; i++) {
               if (images[i].complete) {
                   images[i].classList.add('is-loaded');
               } else {
                   images[i].addEventListener('load', function () {
                       this.classList.add('is-loaded');
                   }, false);
               }
           }</script></body></html>